# 多股票模式使用指南

## 概述

Pearson分析器支持同时分析多个股票的相关性，并针对多股票模式优化了内存管理和分批处理逻辑。

## 多股票模式特性

### 1. 自动模式识别
- **单股票模式**: 传入单个股票代码
- **多股票模式**: 传入多个股票代码（逗号分隔）

### 2. 智能分批处理

#### 分批逻辑说明
在多股票模式下，内存使用量 = `股票数量 × 评测日期数 × 数据维度`

因此，`evaluation_batch_size` 参数的含义在不同模式下有所不同：

- **单股票模式**: 直接表示每批处理的评测日期数
- **多股票模式**: 表示总计算单元数（股票数 × 评测日期数）

#### 计算示例

**示例1: 2股票 × 15评测日期**
```bash
python pearson_analyzer_gpu.py --stock_code "000001,000002" --evaluation_days 15 --evaluation_batch_size 10
```
- 总计算单元: 2 × 15 = 30
- 分批数量: 30 ÷ 10 = 3批
- 每批处理: 5个评测日期 × 2个股票 = 10计算单元

**示例2: 100股票 × 15评测日期**
```bash
python pearson_analyzer_gpu.py --stock_code "股票列表..." --evaluation_days 15 --evaluation_batch_size 20
```
- 总计算单元: 100 × 15 = 1500
- 分批数量: 1500 ÷ 20 = 75批
- 每批处理: 1个评测日期 × 100个股票 = 100计算单元（或其他组合）

### 3. 内存优化

#### 内存预估
系统会自动计算多股票模式下的内存需求：
- 基础数据张量内存 × 股票数量
- 广播张量内存 × 股票数量  
- 中间计算张量内存 × 股票数量

#### 内存节省
通过分批处理，可以显著降低GPU内存峰值使用量：
- 2股票场景: 节省66.7%内存
- 5股票场景: 节省73.3%内存
- 100股票场景: 节省98%+内存

## 使用建议

### 1. 参数配置
- **小规模测试**: `evaluation_batch_size=10-20`
- **中等规模**: `evaluation_batch_size=50-100`  
- **大规模分析**: `evaluation_batch_size=20-50`（根据GPU内存调整）

### 2. 性能优化
- 股票数量越多，建议使用越小的batch_size
- 监控GPU内存使用情况，避免OOM错误
- 利用日志中的内存预估信息调整参数

### 3. 常见场景

#### 场景1: 少量股票深度分析
```bash
# 2-5个股票，较长评测期间
python pearson_analyzer_gpu.py --stock_code "000001,000002,000858" --evaluation_days 30 --evaluation_batch_size 20
```

#### 场景2: 大量股票快速筛选  
```bash
# 50-100个股票，较短评测期间
python pearson_analyzer_gpu.py --stock_code "股票列表..." --evaluation_days 10 --evaluation_batch_size 30
```

#### 场景3: 极大规模分析
```bash
# 100+个股票，需要严格控制内存
python pearson_analyzer_gpu.py --stock_code "股票列表..." --evaluation_days 15 --evaluation_batch_size 20
```

## 日志解读

### 分批信息日志
```
📊 多股票模式总计算量: 5 股票 × 15 评测日期 = 75 计算单元
🔄 多股票分批处理策略: 将 15 个评测日期分成 4 批处理  
📦 每批处理: 4 个评测日期 × 5 个股票 = 20 计算单元
💾 预计GPU内存节省: 73.3%
```

### 内存监控日志
```
🔍 GPU显存监控 [分析开始]:
   当前已分配: 0.00GB
   峰值已分配: 0.01GB
   峰值已保留: 0.14GB
```

## 故障排除

### 1. 内存不足 (OOM)
- 减小 `evaluation_batch_size` 值
- 减少同时分析的股票数量
- 缩短评测期间长度

### 2. 处理速度慢
- 适当增加 `evaluation_batch_size`（在内存允许范围内）
- 检查GPU利用率
- 考虑减少对比股票数量

### 3. 结果异常
- 检查股票代码是否有效
- 确认数据日期范围
- 查看详细日志排查问题

## 技术细节

### 分批算法
1. 计算总计算单元 = 股票数 × 评测日期数
2. 计算批次数 = ceil(总计算单元 ÷ evaluation_batch_size)
3. 计算每批实际处理的评测日期数 = ceil(评测日期数 ÷ 批次数)
4. 按批次顺序处理，最后一批可能包含较少的评测日期

### 内存估算
- 考虑所有GPU张量的内存占用
- 包含PyTorch内存池的预留空间
- 提供详细的内存分解信息

---

更多技术细节请参考源码中的注释和日志输出。