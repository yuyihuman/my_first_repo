<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国宏观经济数据 - 股票信息分析平台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- 添加Chart.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 添加Chart.js annotation插件 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        .chart-container {
            position: relative;
            margin: 20px 0;
            height: 400px;
            width: 100%;
        }
        .chart-container.large {
            height: 500px;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px dashed #dee2e6;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">股票信息分析平台</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/stock_info">个股信息</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/hkstock_info">港股个股信息</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/lhb">龙虎榜</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/hkstock">港股通南向</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link active" href="/macro_china">中国宏观数据</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/sh_house_price">上海房价</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="/institutional_holdings">机构持股</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="jumbotron">
            <h1 class="display-4 text-center">中国宏观经济数据</h1>
            <p class="lead text-center">货币供应量数据分析</p>
            <hr class="my-4">
            
            <div id="updateInfo" class="alert alert-info text-center">
                正在加载数据，请稍候...
            </div>
            
            <!-- 货币供应量同比图表 -->
            <div class="chart-container">
                <div id="moneySupplyChartLoading" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">加载中...</p>
                </div>
                <canvas id="moneySupplyChart"></canvas>
            </div>
            
            <!-- 指数对比图表 -->
            <div class="chart-container">
                <div id="indexComparisonChartLoading" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">加载中...</p>
                </div>
                <canvas id="indexComparisonChart"></canvas>
            </div>
            

            
            <!-- 新增：M1同比增幅和沪深300指数图表 -->
            <div class="chart-container">
                <div id="m1Hs300ChartLoading" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">加载中...</p>
                </div>
                <canvas id="m1Hs300Chart"></canvas>
            </div>
            
            <!-- 新增：M1同比增幅和中证商品期货指数图表 -->
            <div class="chart-container">
                <div id="m1CcidxChartLoading" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">加载中...</p>
                </div>
                <canvas id="m1CcidxChart"></canvas>
            </div>
            
            <!-- 新增：沪深300指数和TTM市盈率图表 -->
            <div class="chart-container">
                <div id="hs300PeChartLoading" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">加载中...</p>
                </div>
                <canvas id="hs300PeChart"></canvas>
            </div>
            
            <!-- 新增：沪深300指数和滚动4Q净利润图表 -->
            <div class="chart-container">
                <div id="hs300ProfitChartLoading" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">加载中...</p>
                </div>
                <canvas id="hs300ProfitChart"></canvas>
            </div>
            
            <!-- 新增：非银行滚动4Q净利润、商品价格指数和沪深300指数图表 -->
            <div class="chart-container large">
                <div id="nonBankProfitCommodityChartLoading" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">加载中...</p>
                </div>
                <canvas id="nonBankProfitCommodityChart"></canvas>
            </div>
            
            <!-- 日志显示区域 -->
            <!-- 日志显示区域 -->
            <!-- <div class="mt-5">
                <h3>API响应日志</h3>
                <div class="log-container" id="apiLogContainer">
                    <div class="log-entry">等待API响应...</div>
                </div>
            </div> -->
        </div>
    </div>

    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">© 2024 股票信息分析平台</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let moneySupplyChart = null;
        let indexComparisonChart = null;
        let m1Hs300Chart = null;
        let m1CcidxChart = null;
        let hs300PeChart = null;
        let hs300ProfitChart = null;
        let nonBankProfitCommodityChart = null;

        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取货币供应量数据
            fetchMoneySupplyData();
        });
        
        // 获取货币供应量数据
        function fetchMoneySupplyData(showLoading = false) {
            // 显示加载状态
            document.getElementById('moneySupplyChartLoading').style.display = 'flex';
            document.getElementById('indexComparisonChartLoading').style.display = 'flex';
            document.getElementById('m1Hs300ChartLoading').style.display = 'flex';
            document.getElementById('m1CcidxChartLoading').style.display = 'flex';
            document.getElementById('hs300PeChartLoading').style.display = 'flex';
            document.getElementById('hs300ProfitChartLoading').style.display = 'flex';
            
            // 发起API请求
            fetch('/api/macro/money_supply')
                .then(response => response.json())
                .then(data => {
                    // 记录API响应到日志区域
                    logApiResponse(data);
                    
                    if (data.status === 'success') {
                        // 更新最后更新时间
                        document.getElementById('updateInfo').innerHTML = 
                            `最后更新时间: ${data.last_update}`;
                        
                        // 处理数据并显示图表
                        processAndDisplayData(data.data);
                    } else {
                        // 显示错误信息
                        document.getElementById('updateInfo').innerHTML = 
                            `<div class="alert alert-danger">获取数据失败: ${data.message}</div>`;
                        
                        // 隐藏加载状态
                        document.getElementById('moneySupplyChartLoading').style.display = 'none';
                        document.getElementById('indexComparisonChartLoading').style.display = 'none';
                        document.getElementById('m1Hs300ChartLoading').style.display = 'none';
                        document.getElementById('m1CcidxChartLoading').style.display = 'none';
                        document.getElementById('hs300PeChartLoading').style.display = 'none';
                        document.getElementById('hs300ProfitChartLoading').style.display = 'none';

    
                    }
                })
                .catch(error => {
                    console.error('获取数据出错:', error);
                    document.getElementById('updateInfo').innerHTML = 
                        `<div class="alert alert-danger">获取数据出错: ${error.message}</div>`;
                    
                    // 记录错误到日志区域
                    logApiResponse({status: 'error', message: error.message});
                    
                    // 隐藏加载状态
                    document.getElementById('moneySupplyChartLoading').style.display = 'none';
                    document.getElementById('indexComparisonChartLoading').style.display = 'none';
                    document.getElementById('m1Hs300ChartLoading').style.display = 'none';
                    document.getElementById('m1CcidxChartLoading').style.display = 'none';
                    document.getElementById('hs300PeChartLoading').style.display = 'none';
                    document.getElementById('hs300ProfitChartLoading').style.display = 'none';
                    document.getElementById('nonBankProfitCommodityChartLoading').style.display = 'none';
                });
        }
        
        // 处理数据并显示图表
        function processAndDisplayData(data) {
            // 反转数据以便按时间顺序显示（从早到晚）
            const sortedData = [...data].reverse();
            
            // 提取数据并处理null值
            const months = sortedData.map(item => item.月份);
            const m2Growth = sortedData.map(item => {
                // 修正字段名：使用正确的字段名
                return item.货币和准货币_广义货币M2_同比 !== null ? 
                    item.货币和准货币_广义货币M2_同比 : null;
            });
            // 添加M1增速数据
            const m1Growth = sortedData.map(item => {
                // 修正字段名：使用正确的字段名
                return item.货币_狭义货币M1_同比 !== null ? 
                    item.货币_狭义货币M1_同比 : null;
            });
            const secondHandHousingData = sortedData.map(item => {
                // 修正字段名：使用正确的字段名
                return item.上海二手住宅价格指数_同比 !== null ? 
                    item.上海二手住宅价格指数_同比 : null;
            });
            
            // 创建图表
            createMoneySupplyChart(months, m2Growth, m1Growth, secondHandHousingData);
            
            // 创建指数对比图表
                        createIndexComparisonChart(sortedData);
                        

                        
                        // 创建M1同比增幅和沪深300指数图表
                        createM1Hs300Chart(sortedData);
                        
                        // 创建M1同比增幅和中证商品期货指数图表
                        createM1CcidxChart(sortedData);
                        
                        // 创建沪深300指数和TTM市盈率图表
                        createHs300PeChart(sortedData);
                        
                        // 创建沪深300指数和滚动4Q净利润图表
                        createHs300ProfitChart(sortedData);
                        
                        // 创建非银行滚动4Q净利润和商品价格指数图表
                        createNonBankProfitCommodityChart(sortedData);
                        
                        // 隐藏加载状态
                        document.getElementById('moneySupplyChartLoading').style.display = 'none';
                        document.getElementById('indexComparisonChartLoading').style.display = 'none';
                        document.getElementById('m1Hs300ChartLoading').style.display = 'none';
                        document.getElementById('m1CcidxChartLoading').style.display = 'none';
                        document.getElementById('hs300PeChartLoading').style.display = 'none';
                        document.getElementById('hs300ProfitChartLoading').style.display = 'none';
                        document.getElementById('nonBankProfitCommodityChartLoading').style.display = 'none';
        }
        
        // 创建货币供应量图表
        function createMoneySupplyChart(months, m2Growth, m1Growth, secondHandHousingData) {
            const ctx = document.getElementById('moneySupplyChart').getContext('2d');
            
            // 销毁旧图表（如果存在）
            if (moneySupplyChart) {
                moneySupplyChart.destroy();
            }
            
            // 创建新图表
            moneySupplyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'M2同比增长(%)',
                            data: m2Growth,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1,
                            // 设置为true，允许跳过null值而不断线
                            spanGaps: true
                        },
                        {
                            label: 'M1同比增长(%)',
                            data: m1Growth,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1,
                            spanGaps: true
                        },
                        {
                            label: '上海二手住宅价格指数同比(%)',
                            data: secondHandHousingData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            // 设置为true，允许跳过null值而不断线
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'M2、M1与上海二手住宅价格指数同比变化(%)'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '同比变化率(%)'
                            },
                            // 添加0轴线配置
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return 'rgba(0, 0, 0, 0.8)'; // 0轴线加粗，颜色更深
                                    }
                                    return 'rgba(0, 0, 0, 0.1)'; // 其他网格线保持原样
                                },
                                lineWidth: function(context) {
                                    if (context.tick.value === 0) {
                                        return 2; // 0轴线加粗
                                    }
                                    return 1; // 其他网格线保持原样
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '月份'
                            }
                        }
                    }
                }
            });
        }
        
        // 创建指数对比图表
        function createIndexComparisonChart(data) {
            // 筛选2011年1月之后的数据
            const filteredData = data.filter(item => {
                if (item['月份'].includes('.')) {
                    const [year, month] = item['月份'].split('.');
                    return parseInt(year) >= 2011;
                } else if (item['月份'].includes('-')) {
                    const [year, month] = item['月份'].split('-');
                    return parseInt(year) >= 2011;
                }
                return false;
            });
            
            const labels = filteredData.map(item => item['月份']);
            const m2IndexData = filteredData.map(item => item['M2指数(2011.1=100)']);
            const m1IndexData = filteredData.map(item => item['M1指数(2011.1=100)']);
            const houseIndexData = filteredData.map(item => item['上海二手住宅价格指数(2011.1=100)']);
            
            const ctx = document.getElementById('indexComparisonChart').getContext('2d');
            
            // 销毁旧图表（如果存在）
            if (indexComparisonChart) {
                indexComparisonChart.destroy();
            }
            
            // 创建新图表
            indexComparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'M2指数(2011.1=100)',
                            data: m2IndexData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            spanGaps: true
                        },
                        {
                            label: 'M1指数(2011.1=100)',
                            data: m1IndexData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            spanGaps: true
                        },
                        {
                            label: '上海二手住宅价格指数(2011.1=100)',
                            data: houseIndexData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'M2、M1和上海二手房价指数对比(2011.1=100)',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            },
                            title: {
                                display: true,
                                text: '月份'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '指数值(2011.1=100)'
                            }
                        }
                    }
                }
            });
        }
        

        
        // 创建M1同比增幅和沪深300指数图表
        function createM1Hs300Chart(data) {
            const ctx = document.getElementById('m1Hs300Chart').getContext('2d');
            
            // 提取数据
            const labels = data.map(item => item.月份);
            const m1Data = data.map(item => item.货币_狭义货币M1_同比);
            const hs300Data = data.map(item => item.沪深300指数);
            
            // 定义重要时间节点
            const timePoints = ['2002.2', '2005.5', '2008.12', '2012.1', '2015.3', '2019.1', '2021.11', '2024.9'];
            
            // 计算相邻时间点间的月数
            function calculateMonthsBetween(date1, date2) {
                const [year1, month1] = date1.split('.').map(Number);
                const [year2, month2] = date2.split('.').map(Number);
                return (year2 - year1) * 12 + (month2 - month1);
            }
            
            // 创建注释配置
            const annotations = {};
            
            // 添加垂直线
            timePoints.forEach((point, index) => {
                annotations[`line${index}`] = {
                    type: 'line',
                    xMin: point,
                    xMax: point,
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5]
                };
            });
            
            // 添加月数标注
            for (let i = 0; i < timePoints.length - 1; i++) {
                const months = calculateMonthsBetween(timePoints[i], timePoints[i + 1]);
                const midPoint = timePoints[i]; // 在起始点附近显示
                
                annotations[`label${i}`] = {
                    type: 'label',
                    xValue: midPoint,
                    yValue: 'max',
                    content: `${months}个月`,
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 1,
                    font: {
                        size: 10
                    },
                    position: 'start',
                    yAdjust: -20
                };
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'M1同比增幅 (%)',
                            data: m1Data,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            pointRadius: 1,
                            tension: 0.1,
                            spanGaps: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '沪深300指数',
                            data: hs300Data,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            pointRadius: 1,
                            tension: 0.1,
                            spanGaps: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'M1同比增幅与沪深300指数对比',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            },
                            title: {
                                display: true,
                                text: '月份'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'M1同比增幅 (%)',
                                color: 'rgba(54, 162, 235, 1)'
                            },
                            ticks: {
                                color: 'rgba(54, 162, 235, 1)'
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return 'rgba(0, 0, 0, 0.8)';
                                    }
                                    return 'rgba(0, 0, 0, 0.1)';
                                },
                                lineWidth: function(context) {
                                    if (context.tick.value === 0) {
                                        return 2;
                                    }
                                    return 1;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '沪深300指数',
                                color: 'rgba(255, 99, 132, 1)'
                            },
                            ticks: {
                                color: 'rgba(255, 99, 132, 1)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // 创建M1同比增幅和上海二手住宅价格指数同比图表
        function createM1CcidxChart(data) {
            const ctx = document.getElementById('m1CcidxChart').getContext('2d');
            
            // 提取数据
            const labels = data.map(item => item.月份);
            const m1Data = data.map(item => item.货币_狭义货币M1_同比);
            const houseData = data.map(item => item.上海二手住宅价格指数_同比);
            
            // 调试：输出上海二手住宅价格指数同比数据
            console.log('上海二手住宅价格指数同比数据样本:', houseData.slice(0, 10));
            console.log('非空上海二手住宅价格指数同比数据数量:', houseData.filter(val => val !== null && val !== undefined).length);
            console.log('总数据条数:', houseData.length);
            console.log('数据样本:', data.slice(0, 3));
            
            // 定义重要时间节点
            const timePoints = ['2002.2', '2005.5', '2008.12', '2012.1', '2015.3', '2019.1', '2021.11', '2024.9'];
            
            // 计算相邻时间点间的月数
            function calculateMonthsBetween(date1, date2) {
                const [year1, month1] = date1.split('.').map(Number);
                const [year2, month2] = date2.split('.').map(Number);
                return (year2 - year1) * 12 + (month2 - month1);
            }
            
            // 创建注释配置
            const annotations = {};
            
            // 添加垂直线
            timePoints.forEach((point, index) => {
                annotations[`line${index}`] = {
                    type: 'line',
                    xMin: point,
                    xMax: point,
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5]
                };
            });
            
            // 添加月数标注
            for (let i = 0; i < timePoints.length - 1; i++) {
                const months = calculateMonthsBetween(timePoints[i], timePoints[i + 1]);
                const midPoint = timePoints[i]; // 在起始点附近显示
                
                annotations[`label${i}`] = {
                    type: 'label',
                    xValue: midPoint,
                    yValue: 'max',
                    content: `${months}个月`,
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 1,
                    font: {
                        size: 10
                    },
                    position: 'start',
                    yAdjust: -20
                };
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'M1同比增幅 (%)',
                            data: m1Data,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            pointRadius: 1,
                            tension: 0.1,
                            spanGaps: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '上海二手住宅价格指数同比 (%)',
                            data: houseData,
                            borderColor: 'rgba(255, 165, 0, 1)',
                            backgroundColor: 'rgba(255, 165, 0, 0.2)',
                            borderWidth: 2,
                            pointRadius: 1,
                            tension: 0.1,
                            spanGaps: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'M1同比增幅与上海二手住宅价格指数同比对比',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            },
                            title: {
                                display: true,
                                text: '月份'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'M1同比增幅 (%)',
                                color: 'rgba(54, 162, 235, 1)'
                            },
                            ticks: {
                                color: 'rgba(54, 162, 235, 1)'
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return 'rgba(0, 0, 0, 0.8)';
                                    }
                                    return 'rgba(0, 0, 0, 0.1)';
                                },
                                lineWidth: function(context) {
                                    if (context.tick.value === 0) {
                                        return 2;
                                    }
                                    return 1;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '上海二手住宅价格指数同比 (%)',
                                color: 'rgba(255, 165, 0, 1)'
                            },
                            ticks: {
                                color: 'rgba(255, 165, 0, 1)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // 创建沪深300指数和TTM市盈率图表
        function createHs300PeChart(data) {
            const ctx = document.getElementById('hs300PeChart').getContext('2d');
            
            // 提取数据
            const labels = data.map(item => item.月份);
            const hs300Data = data.map(item => {
                return item.沪深300指数 !== null ? item.沪深300指数 : null;
            });
            const ttmPeData = data.map(item => {
                return item.TTM市盈率 !== null ? item.TTM市盈率 : null;
            });
            const bankTtmPeData = data.map(item => {
                return item.银行TTM市盈率 !== null ? item.银行TTM市盈率 : null;
            });
            const nonBankTtmPeData = data.map(item => {
                return item.非银行TTM市盈率 !== null ? item.非银行TTM市盈率 : null;
            });
            
            // 过滤掉所有数据都为null的点
            const filteredData = [];
            const filteredLabels = [];
            const filteredHs300 = [];
            const filteredTtmPe = [];
            const filteredBankTtmPe = [];
            const filteredNonBankTtmPe = [];
            
            for (let i = 0; i < labels.length; i++) {
                if (hs300Data[i] !== null || ttmPeData[i] !== null || bankTtmPeData[i] !== null || nonBankTtmPeData[i] !== null) {
                    filteredLabels.push(labels[i]);
                    filteredHs300.push(hs300Data[i]);
                    filteredTtmPe.push(ttmPeData[i]);
                    filteredBankTtmPe.push(bankTtmPeData[i]);
                    filteredNonBankTtmPe.push(nonBankTtmPeData[i]);
                }
            }
            
            // 定义重要时间节点
            const timePoints = ['2002.2', '2005.5', '2008.12', '2012.1', '2015.3', '2019.1', '2021.11', '2024.9'];
            
            // 计算相邻时间点间的月数
            function calculateMonthsBetween(date1, date2) {
                const [year1, month1] = date1.split('.').map(Number);
                const [year2, month2] = date2.split('.').map(Number);
                return (year2 - year1) * 12 + (month2 - month1);
            }
            
            // 创建注释配置
            const annotations = {};
            
            // 添加垂直线
            timePoints.forEach((point, index) => {
                annotations[`line${index}`] = {
                    type: 'line',
                    xMin: point,
                    xMax: point,
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5]
                };
            });
            
            // 添加月数标注
            for (let i = 0; i < timePoints.length - 1; i++) {
                const months = calculateMonthsBetween(timePoints[i], timePoints[i + 1]);
                const midPoint = timePoints[i]; // 在起始点附近显示
                
                annotations[`label${i}`] = {
                    type: 'label',
                    xValue: midPoint,
                    yValue: 'max',
                    content: `${months}个月`,
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 1,
                    font: {
                        size: 10
                    },
                    position: 'start',
                    yAdjust: -20
                };
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredLabels,
                    datasets: [
                        {
                            label: '沪深300指数',
                            data: filteredHs300,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            spanGaps: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'TTM市盈率',
                            data: filteredTtmPe,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            spanGaps: true,
                            yAxisID: 'y1'
                        },
                        {
                            label: '银行TTM市盈率',
                            data: filteredBankTtmPe,
                            borderColor: 'rgba(0, 191, 255, 1)',
                            backgroundColor: 'rgba(0, 191, 255, 0.2)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            spanGaps: true,
                            yAxisID: 'y1'
                        },
                        {
                            label: '非银行TTM市盈率',
                            data: filteredNonBankTtmPe,
                            borderColor: 'rgba(255, 206, 84, 1)',
                            backgroundColor: 'rgba(255, 206, 84, 0.2)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            spanGaps: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '沪深300指数与TTM市盈率对比（含银行/非银行分类）',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.dataset.label === 'TTM市盈率' || context.dataset.label === '银行TTM市盈率' || context.dataset.label === '非银行TTM市盈率') {
                                            label += context.parsed.y.toFixed(2) + '倍';
                                        } else {
                                            label += context.parsed.y.toFixed(2);
                                        }
                                    }
                                    return label;
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            },
                            title: {
                                display: true,
                                text: '月份'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '沪深300指数',
                                color: 'rgba(255, 99, 132, 1)'
                            },
                            ticks: {
                                color: 'rgba(255, 99, 132, 1)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'TTM市盈率 (倍)',
                                color: 'rgba(75, 192, 192, 1)'
                            },
                            ticks: {
                                color: 'rgba(75, 192, 192, 1)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // 创建沪深300指数和滚动4Q净利润图表
        function createHs300ProfitChart(data) {
            // 提取数据
            const months = data.map(item => item.月份);
            const hs300Index = data.map(item => item.沪深300指数);
            const rolling4qProfit = data.map(item => item.滚动4Q净利润);
            const bankRolling4qProfit = data.map(item => item.银行滚动4Q净利润);
            const nonBankRolling4qProfit = data.map(item => item.非银行滚动4Q净利润);
            
            // 过滤掉所有数据都为null的点
            const filteredData = [];
            for (let i = 0; i < months.length; i++) {
                if (hs300Index[i] !== null || rolling4qProfit[i] !== null || bankRolling4qProfit[i] !== null || nonBankRolling4qProfit[i] !== null) {
                    filteredData.push({
                        month: months[i],
                        hs300: hs300Index[i],
                        profit: rolling4qProfit[i],
                        bankProfit: bankRolling4qProfit[i],
                        nonBankProfit: nonBankRolling4qProfit[i]
                    });
                }
            }
            
            const ctx = document.getElementById('hs300ProfitChart').getContext('2d');
            
            // 销毁旧图表（如果存在）
            if (hs300ProfitChart) {
                hs300ProfitChart.destroy();
            }
            
            // 定义重要时间节点
            const timePoints = ['2002.2', '2005.5', '2008.12', '2012.1', '2015.3', '2019.1', '2021.11', '2024.9'];
            
            // 计算相邻时间点间的月数
            function calculateMonthsBetween(date1, date2) {
                const [year1, month1] = date1.split('.').map(Number);
                const [year2, month2] = date2.split('.').map(Number);
                return (year2 - year1) * 12 + (month2 - month1);
            }
            
            // 创建注释配置
            const annotations = {};
            
            // 添加垂直线
            timePoints.forEach((point, index) => {
                annotations[`line${index}`] = {
                    type: 'line',
                    xMin: point,
                    xMax: point,
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5]
                };
            });
            
            // 添加月数标注
            for (let i = 0; i < timePoints.length - 1; i++) {
                const months = calculateMonthsBetween(timePoints[i], timePoints[i + 1]);
                const midPoint = timePoints[i]; // 在起始点附近显示
                
                annotations[`label${i}`] = {
                    type: 'label',
                    xValue: midPoint,
                    yValue: 'max',
                    content: `${months}个月`,
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 1,
                    font: {
                        size: 10
                    },
                    position: 'start',
                    yAdjust: -20
                };
            }
            
            hs300ProfitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.map(item => item.month),
                    datasets: [{
                        label: '沪深300指数',
                        data: filteredData.map(item => item.hs300),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.1,
                        spanGaps: true,
                        yAxisID: 'y'
                    }, {
                        label: '滚动4Q净利润 (亿元)',
                        data: filteredData.map(item => item.profit),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.1,
                        spanGaps: true,
                        yAxisID: 'y1'
                    }, {
                        label: '银行滚动4Q净利润 (亿元)',
                        data: filteredData.map(item => item.bankProfit),
                        borderColor: 'rgba(0, 191, 255, 1)',
                        backgroundColor: 'rgba(0, 191, 255, 0.2)',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.1,
                        spanGaps: true,
                        yAxisID: 'y1'
                    }, {
                        label: '非银行滚动4Q净利润 (亿元)',
                        data: filteredData.map(item => item.nonBankProfit),
                        borderColor: 'rgba(255, 206, 84, 1)',
                        backgroundColor: 'rgba(255, 206, 84, 0.2)',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.1,
                        spanGaps: true,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '沪深300指数与滚动4Q净利润对比（含银行/非银行分类）',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: true
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '月份'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '沪深300指数',
                                color: 'rgba(255, 99, 132, 1)'
                            },
                            ticks: {
                                color: 'rgba(255, 99, 132, 1)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '滚动4Q净利润 (亿元)',
                                color: 'rgba(54, 162, 235, 1)'
                            },
                            ticks: {
                                color: 'rgba(54, 162, 235, 1)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // 创建非银行滚动4Q净利润、商品价格指数和沪深300指数图表
        function createNonBankProfitCommodityChart(data) {
            const ctx = document.getElementById('nonBankProfitCommodityChart').getContext('2d');
            
            // 销毁旧图表（如果存在）
            if (nonBankProfitCommodityChart) {
                nonBankProfitCommodityChart.destroy();
            }
            
            // 提取和过滤数据
            const filteredData = data.filter(item => {
                return item.非银行滚动4Q净利润 !== null || item.商品价格指数 !== null || item.沪深300指数 !== null;
            });
            
            const months = filteredData.map(item => item.月份);
            const nonBankProfit = filteredData.map(item => item.非银行滚动4Q净利润);
            const commodityIndex = filteredData.map(item => item.商品价格指数);
            const hs300Index = filteredData.map(item => item.沪深300指数);
            
            // 定义重要时间节点
            const timePoints = ['2002.2', '2005.5', '2008.12', '2012.1', '2015.3', '2019.1', '2021.11', '2024.9'];
            
            // 计算相邻时间点间的月数
            function calculateMonthsBetween(date1, date2) {
                const [year1, month1] = date1.split('.').map(Number);
                const [year2, month2] = date2.split('.').map(Number);
                return (year2 - year1) * 12 + (month2 - month1);
            }
            
            // 创建注释配置
            const annotations = {};
            
            // 添加垂直线
            timePoints.forEach((point, index) => {
                annotations[`line${index}`] = {
                    type: 'line',
                    xMin: point,
                    xMax: point,
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5]
                };
            });
            
            // 添加月数标注
            for (let i = 0; i < timePoints.length - 1; i++) {
                const months = calculateMonthsBetween(timePoints[i], timePoints[i + 1]);
                const midPoint = timePoints[i]; // 在起始点附近显示
                
                annotations[`label${i}`] = {
                    type: 'label',
                    xValue: midPoint,
                    yValue: 'max',
                    content: `${months}个月`,
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    borderColor: 'rgba(128, 128, 128, 0.8)',
                    borderWidth: 1,
                    font: {
                        size: 10
                    },
                    position: 'start',
                    yAdjust: -20
                };
            }
            
            // 创建新图表
            nonBankProfitCommodityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '非银行滚动4Q净利润',
                            data: nonBankProfit,
                            borderColor: 'rgba(255, 206, 84, 1)',
                            backgroundColor: 'rgba(255, 206, 84, 0.2)',
                            yAxisID: 'y',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            spanGaps: true
                        },
                        {
                            label: '商品价格指数',
                            data: commodityIndex,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            yAxisID: 'y1',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            spanGaps: true
                        },
                        {
                            label: '沪深300指数',
                            data: hs300Index,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            yAxisID: 'y2',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '非银行滚动4Q净利润、商品价格指数与沪深300指数对比',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: true
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '时间'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '非银行滚动4Q净利润 (亿元)',
                                color: 'rgba(255, 206, 84, 1)'
                            },
                            ticks: {
                                color: 'rgba(255, 206, 84, 1)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '商品价格指数',
                                color: 'rgba(153, 102, 255, 1)'
                            },
                            ticks: {
                                color: 'rgba(153, 102, 255, 1)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '沪深300指数',
                                color: 'rgba(75, 192, 192, 1)'
                            },
                            ticks: {
                                color: 'rgba(75, 192, 192, 1)'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            offset: true
                        }
                    }
                }
            });
        }
        
        // 记录API响应到日志
        function logApiResponse(data) {
            // 由于日志区域已被注释掉，此函数可以保留但不执行任何操作
            return;
            
            // 以下代码不会执行
            const logContainer = document.getElementById('apiLogContainer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            let logContent = `[${timestamp}] `;
            
            if (data.status === 'error') {
                logContent += `错误: ${data.message}`;
                logEntry.style.color = 'red';
            } else {
                logContent += `成功获取数据, 最后更新: ${data.last_update}`;
                logContent += `, 数据条数: ${data.data ? data.data.length : 0}`;
                logEntry.style.color = 'green';
            }
            
            logEntry.textContent = logContent;
            
            // 添加到日志容器的顶部
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // 限制日志条目数量
            const maxLogEntries = 50;
            while (logContainer.children.length > maxLogEntries) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
    </script>
</body>
</html>