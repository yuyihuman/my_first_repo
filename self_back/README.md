# è‚¡ç¥¨å›æµ‹ç¨‹åº

ä¸€ä¸ªå®Œæ•´çš„è‚¡ç¥¨å›æµ‹ç³»ç»Ÿï¼Œæ”¯æŒå•ç¬”å’Œæ‰¹é‡äº¤æ˜“çš„æ”¶ç›Šç‡è®¡ç®—ã€ç­–ç•¥å›æµ‹å’ŒæŠ¥å‘Šç”Ÿæˆã€‚

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒæ¨¡å—

1. **é€‰è‚¡æ¨¡å—** (`modules/stock_selector.py`)
   - æä¾›è‚¡ç¥¨é€‰æ‹©ç­–ç•¥æ¥å£
   - æ”¯æŒè‡ªå®šä¹‰é€‰è‚¡ç­–ç•¥æ³¨å†Œ
   - **å†…ç½®QFIIé€‰è‚¡ç­–ç•¥** â­
     - åŸºäºæœºæ„æŒä»“æ•°æ®ç­›é€‰æ›¾ç»æœ‰QFIIæŒä»“çš„è‚¡ç¥¨
     - æ”¯æŒè‡ªå®šä¹‰æ•°æ®æ–‡ä»¶è·¯å¾„
     - è‡ªåŠ¨éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼
   - é¢„ç•™å¤šç§é€‰è‚¡ç®—æ³•æ¥å£

2. **ä¹°å…¥ç­–ç•¥æ¨¡å—** (`modules/buy_strategy.py`)
   - å®šä¹‰å¤šç§ä¹°å…¥ç­–ç•¥
   - æ”¯æŒç­–ç•¥æ³¨å†Œå’ŒåŠ¨æ€è°ƒç”¨
   - é¢„ç•™æŠ€æœ¯æŒ‡æ ‡å’ŒåŸºæœ¬é¢åˆ†ææ¥å£

3. **å–å‡ºç­–ç•¥æ¨¡å—** (`modules/sell_strategy.py`)
   - å®šä¹‰å¤šç§å–å‡ºç­–ç•¥
   - æ”¯æŒæ­¢æŸã€æ­¢ç›ˆã€æŒæœ‰æœŸç­‰ç­–ç•¥
   - çµæ´»çš„ç­–ç•¥ç»„åˆæœºåˆ¶

4. **æ”¶ç›Šç‡è®¡ç®—æ¨¡å—** (`modules/return_calculator.py`) â­
   - **å·²å®Œæ•´å®ç°**
   - ä½¿ç”¨ `xtdata` API è·å–çœŸå®è‚¡ç¥¨æ•°æ®
   - æ”¯æŒå•ç¬”å’Œæ‰¹é‡äº¤æ˜“æ”¶ç›Šç‡è®¡ç®—
   - è‡ªåŠ¨å¤„ç†é™¤æƒé™¤æ¯
   - æä¾›å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—
   - æ™ºèƒ½æ—¥æœŸåŒ¹é…ï¼ˆè‡ªåŠ¨æ‰¾åˆ°æœ€è¿‘äº¤æ˜“æ—¥ï¼‰
   - æ¨¡æ‹Ÿæ•°æ®æ”¯æŒï¼ˆå½“ xtdata ä¸å¯ç”¨æ—¶ï¼‰

5. **æŠ¥å‘Šç”Ÿæˆæ¨¡å—** (`modules/report_generator.py`)
   - å¤šç§æŠ¥å‘Šæ ¼å¼ï¼šç®€å•ã€è¯¦ç»†ã€æ‘˜è¦
   - æ”¯æŒ JSONã€HTML è¾“å‡ºæ ¼å¼
   - è‡ªåŠ¨ç»Ÿè®¡åˆ†æå’Œé£é™©æŒ‡æ ‡
   - æŠ¥å‘Šä¿å­˜åŠŸèƒ½

### è¾…åŠ©å·¥å…·

- **æ—¥å¿—ç³»ç»Ÿ** (`utils/logger.py`)
  - ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†
  - æŒ‰æ—¥æœŸå’Œæ¨¡å—åˆ†ç±»å­˜å‚¨
  - è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯è®°å½•

- **å›æµ‹å¼•æ“** (`main.py`)
  - æ•´åˆæ‰€æœ‰æ¨¡å—çš„ä¸»å¼•æ“
  - æä¾›å®Œæ•´çš„å›æµ‹æµç¨‹
  - ç¤ºä¾‹ä»£ç å’Œä½¿ç”¨æ¼”ç¤º

## å®‰è£…å’Œä½¿ç”¨

### ç¯å¢ƒè¦æ±‚

- Python 3.7+
- pandas >= 1.5.0
- numpy >= 1.21.0

### å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### å¯é€‰ä¾èµ–

å¦‚æœéœ€è¦è·å–çœŸå®è‚¡ç¥¨æ•°æ®ï¼Œè¯·å®‰è£… xtquantï¼š

```bash
# æ³¨æ„ï¼šxtquant éœ€è¦ä»å®˜æ–¹æ¸ é“è·å–
# pip install xtquant
```

å¦‚æœæ²¡æœ‰å®‰è£… xtquantï¼Œç¨‹åºä¼šè‡ªåŠ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤ºã€‚

## å¿«é€Ÿå¼€å§‹

### è¿è¡Œç¤ºä¾‹

```bash
python main.py
```

è¿™å°†è¿è¡Œå†…ç½®çš„ç¤ºä¾‹ï¼ŒåŒ…æ‹¬ï¼š
- å•ç¬”äº¤æ˜“å›æµ‹
- æ‰¹é‡äº¤æ˜“å›æµ‹
- æŠ¥å‘Šç”Ÿæˆå’Œä¿å­˜

### åŸºæœ¬ç”¨æ³•

#### 1. å•ç¬”äº¤æ˜“å›æµ‹

```python
from main import BacktestEngine

# åˆ›å»ºå›æµ‹å¼•æ“
engine = BacktestEngine()

# è®¡ç®—å•ç¬”äº¤æ˜“æ”¶ç›Šç‡
result = engine.run_single_trade_backtest(
    stock_code='000001.SZ',  # å¹³å®‰é“¶è¡Œ
    buy_date='20240101',     # ä¹°å…¥æ—¥æœŸ
    sell_date='20240201'     # å–å‡ºæ—¥æœŸ
)

if result['success']:
    print(f"æ”¶ç›Šç‡: {result['return_percentage']:.2f}%")
    print(f"å¹´åŒ–æ”¶ç›Šç‡: {result['annual_return_percentage']:.2f}%")
else:
    print(f"è®¡ç®—å¤±è´¥: {result['error']}")
```

#### 2. æ‰¹é‡äº¤æ˜“å›æµ‹

```python
# å®šä¹‰äº¤æ˜“åˆ—è¡¨
trades = [
    {
        'stock_code': '000001.SZ',
        'buy_date': '20240101',
        'sell_date': '20240201'
    },
    {
        'stock_code': '000002.SZ',
        'buy_date': '20240115',
        'sell_date': '20240215'
    }
]

# è¿è¡Œæ‰¹é‡å›æµ‹
result = engine.run_batch_backtest(trades)

if result['success']:
    summary = result['summary']
    print(f"æ€»äº¤æ˜“æ¬¡æ•°: {summary['total_trades']}")
    print(f"å¹³å‡æ”¶ç›Šç‡: {summary['average_return_percentage']:.2f}%")
```

#### 3. QFIIé€‰è‚¡ç­–ç•¥ï¼ˆå¢å¼ºç‰ˆï¼‰

å¢å¼ºç‰ˆQFIIé€‰è‚¡ç­–ç•¥åŸºäºæœºæ„æŒä»“æ•°æ®ï¼Œé‡‡ç”¨æ™ºèƒ½æ’åºç®—æ³•é€‰å‡ºæœ€å—QFIIé’ççš„ä¼˜è´¨è‚¡ç¥¨ã€‚

**ç­–ç•¥ç‰¹ç‚¹ï¼š**
- ğŸ“Š **å‡ºç°æ¬¡æ•°ç»Ÿè®¡**ï¼šç»Ÿè®¡æ¯åªè‚¡ç¥¨åœ¨QFIIæŒä»“è®°å½•ä¸­çš„å‡ºç°æ¬¡æ•°
- ğŸ† **åŒé‡æ’åº**ï¼šæŒ‰å‡ºç°æ¬¡æ•°é™åºæ’åˆ—ï¼Œç›¸åŒæ¬¡æ•°æ—¶æŒ‰æ€»è‚¡æœ¬é™åºæ’åˆ—
- ğŸ¯ **ç²¾é€‰å‰100**ï¼šä»æ‰€æœ‰QFIIæŒä»“è‚¡ç¥¨ä¸­ç²¾é€‰å‰100åª
- ğŸ“ˆ **è´¨é‡ä¼˜å…ˆ**ï¼šä¼˜å…ˆé€‰æ‹©æœ€å—QFIIé’çä¸”è§„æ¨¡è¾ƒå¤§çš„è‚¡ç¥¨
- ğŸ” **é€æ˜æ’åº**ï¼šæä¾›è¯¦ç»†çš„æ’åºç»Ÿè®¡ä¿¡æ¯

```python
# ä½¿ç”¨å¢å¼ºç‰ˆQFIIé€‰è‚¡ç­–ç•¥
qfii_stocks = engine.select_stocks(
    strategy='qfii_stocks',
    data_file_path='path/to/merged_holdings_data.csv'
)

print(f"QFIIé€‰è‚¡ç»“æœ: å…±é€‰å‡º {len(qfii_stocks)} åªè‚¡ç¥¨")
print(f"å‰20åªè‚¡ç¥¨: {qfii_stocks[:20]}")

# ç­–ç•¥ä¼šè‡ªåŠ¨æ˜¾ç¤ºæ’åºç»Ÿè®¡ä¿¡æ¯
# åŒ…æ‹¬ï¼šæ€»é€‰è‚¡æ•°ã€ç­–ç•¥ç‰¹ç‚¹ã€æ•°æ®æ¥æºç­‰

# å¯¹QFIIè‚¡ç¥¨è¿›è¡Œæ‰¹é‡å›æµ‹
if qfii_stocks:
    trades = []
    for stock in qfii_stocks[:5]:  # é€‰æ‹©å‰5åªè‚¡ç¥¨
        trades.append({
            'stock_code': stock,
            'buy_date': '20240101',
            'sell_date': '20240301'
        })
    
    result = engine.run_batch_backtest(trades)
    if result['success']:
        print(f"QFIIè‚¡ç¥¨å¹³å‡æ”¶ç›Šç‡: {result['summary']['average_return_percentage']:.2f}%")
```

**æ’åºé€»è¾‘ï¼š**
1. ç»Ÿè®¡æ¯åªè‚¡ç¥¨åœ¨QFIIæŒä»“è®°å½•ä¸­çš„å‡ºç°æ¬¡æ•°
2. è·å–æ¯åªè‚¡ç¥¨çš„æ€»è‚¡æœ¬ä¿¡æ¯
3. æŒ‰å‡ºç°æ¬¡æ•°é™åºæ’åˆ—ï¼ˆå‡ºç°æ¬¡æ•°è¶Šå¤šï¼Œè¯´æ˜è¶Šå—QFIIé’çï¼‰
4. å‡ºç°æ¬¡æ•°ç›¸åŒæ—¶ï¼ŒæŒ‰æ€»è‚¡æœ¬é™åºæ’åˆ—ï¼ˆä¼˜å…ˆé€‰æ‹©å¤§ç›˜è‚¡ï¼‰
5. æœ€ç»ˆé€‰å–å‰100åªè‚¡ç¥¨

**é¢„æœŸæ•ˆæœï¼š**
- âœ… é€‰å‡ºæœ€å—QFIIé’ççš„è‚¡ç¥¨ï¼ˆå‡ºç°æ¬¡æ•°å¤šï¼‰
- âœ… åœ¨åŒç­‰é’çåº¦ä¸‹ï¼Œä¼˜å…ˆé€‰æ‹©å¤§ç›˜è‚¡ï¼ˆæ€»è‚¡æœ¬å¤§ï¼‰
- âœ… æ§åˆ¶é€‰è‚¡æ•°é‡ï¼Œæé«˜é€‰è‚¡è´¨é‡
- âœ… æä¾›é€æ˜çš„æ’åºä¾æ®

#### 4. ç”ŸæˆæŠ¥å‘Š

```python
# ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šå¹¶ä¿å­˜
report_result = engine.generate_backtest_report(
    backtest_result=result,
    report_type='detailed',  # 'simple', 'detailed', 'summary'
    output_format='json',    # 'dict', 'json', 'html'
    save_to_file=True
)

if report_result['success']:
    print("æŠ¥å‘Šç”ŸæˆæˆåŠŸ")
    if 'saved_file' in report_result:
        print(f"æŠ¥å‘Šå·²ä¿å­˜åˆ°: {report_result['saved_file']}")
```

## é¡¹ç›®ç»“æ„

```
self_back/
â”œâ”€â”€ main.py                 # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ requirements.txt        # ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ README.md              # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ api.md                 # xtdata API æ–‡æ¡£
â”œâ”€â”€ modules/               # æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ stock_selector.py      # é€‰è‚¡æ¨¡å—
â”‚   â”œâ”€â”€ buy_strategy.py        # ä¹°å…¥ç­–ç•¥æ¨¡å—
â”‚   â”œâ”€â”€ sell_strategy.py       # å–å‡ºç­–ç•¥æ¨¡å—
â”‚   â”œâ”€â”€ return_calculator.py   # æ”¶ç›Šç‡è®¡ç®—æ¨¡å— â­
â”‚   â””â”€â”€ report_generator.py    # æŠ¥å‘Šç”Ÿæˆæ¨¡å—
â”œâ”€â”€ utils/                 # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ logger.py             # æ—¥å¿—å·¥å…·
â””â”€â”€ logs/                  # æ—¥å¿—æ–‡ä»¶ç›®å½•
    â”œâ”€â”€ YYYYMMDD/             # æŒ‰æ—¥æœŸåˆ†ç±»çš„æ—¥å¿—
    â””â”€â”€ backtest_report_*.json # ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶
```

## æ”¶ç›Šç‡è®¡ç®—æ¨¡å—è¯¦è§£

### æ ¸å¿ƒåŠŸèƒ½

1. **æ•°æ®è·å–**
   - ä½¿ç”¨ `xtdata.get_market_data()` è·å–1æ—¥å‘¨æœŸè‚¡ç¥¨æ•°æ®
   - æ”¯æŒé™¤æƒé™¤æ¯å¤„ç†
   - è‡ªåŠ¨ä¸‹è½½å†å²æ•°æ®
   - æ¨¡æ‹Ÿæ•°æ®å¤‡ç”¨æ–¹æ¡ˆ

2. **æ™ºèƒ½æ—¥æœŸå¤„ç†**
   - è‡ªåŠ¨æŸ¥æ‰¾æœ€è¿‘çš„äº¤æ˜“æ—¥
   - ä¹°å…¥æ—¥æœŸï¼šå‘åæŸ¥æ‰¾ç¬¬ä¸€ä¸ªäº¤æ˜“æ—¥
   - å–å‡ºæ—¥æœŸï¼šå‘å‰æŸ¥æ‰¾æœ€åä¸€ä¸ªäº¤æ˜“æ—¥

3. **æ”¶ç›Šç‡è®¡ç®—**
   - ç®€å•æ”¶ç›Šç‡ï¼š`(å–å‡ºä»· - ä¹°å…¥ä»·) / ä¹°å…¥ä»·`
   - å¹´åŒ–æ”¶ç›Šç‡ï¼š`æ”¶ç›Šç‡ Ã— (365 / æŒæœ‰å¤©æ•°)`
   - æŒæœ‰æœŸè®¡ç®—

4. **æ‰¹é‡å¤„ç†**
   - æ”¯æŒå¤šç¬”äº¤æ˜“åŒæ—¶è®¡ç®—
   - ç»Ÿè®¡æ±‡æ€»ä¿¡æ¯
   - é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### API å‚è€ƒ

#### `calculate_return(stock_code, buy_date, sell_date, dividend_type='none')`

è®¡ç®—å•ç¬”äº¤æ˜“æ”¶ç›Šç‡ã€‚

**å‚æ•°ï¼š**
- `stock_code` (str): è‚¡ç¥¨ä»£ç ï¼Œæ ¼å¼å¦‚ '000001.SZ'
- `buy_date` (str): ä¹°å…¥æ—¥æœŸï¼Œæ ¼å¼ä¸º 'YYYYMMDD'
- `sell_date` (str): å–å‡ºæ—¥æœŸï¼Œæ ¼å¼ä¸º 'YYYYMMDD'
- `dividend_type` (str): é™¤æƒæ–¹å¼ï¼Œé»˜è®¤ 'none'

**è¿”å›ï¼š**
```python
{
    'success': True,
    'stock_code': '000001.SZ',
    'buy_date': '20240101',
    'sell_date': '20240201',
    'actual_buy_date': '20240102',  # å®é™…äº¤æ˜“æ—¥
    'actual_sell_date': '20240201',
    'buy_price': 10.50,
    'sell_price': 11.20,
    'return_rate': 0.0667,          # æ”¶ç›Šç‡
    'return_percentage': 6.67,      # æ”¶ç›Šç‡ç™¾åˆ†æ¯”
    'annual_return': 0.8333,        # å¹´åŒ–æ”¶ç›Šç‡
    'annual_return_percentage': 83.33,
    'hold_days': 30,                # æŒæœ‰å¤©æ•°
    'dividend_type': 'none'
}
```

#### `calculate_batch_returns(trades)`

æ‰¹é‡è®¡ç®—å¤šç¬”äº¤æ˜“æ”¶ç›Šç‡ã€‚

**å‚æ•°ï¼š**
- `trades` (list): äº¤æ˜“åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å« stock_code, buy_date, sell_date

**è¿”å›ï¼š**
```python
{
    'success': True,
    'results': [...],  # æ¯ç¬”äº¤æ˜“çš„è¯¦ç»†ç»“æœ
    'summary': {
        'total_trades': 3,
        'successful_trades': 2,
        'failed_trades': 1,
        'total_return': 0.15,
        'average_return': 0.075,
        'average_return_percentage': 7.5
    }
}
```

## æ—¥å¿—ç³»ç»Ÿ

æ‰€æœ‰æ“ä½œéƒ½ä¼šè®°å½•è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼š

- **ä½ç½®**: `logs/YYYYMMDD/` ç›®å½•
- **æ–‡ä»¶**: æŒ‰æ¨¡å—åˆ†ç±»ï¼ˆå¦‚ `return_calculator.log`ï¼‰
- **çº§åˆ«**: INFOï¼ˆå…³é”®æ“ä½œï¼‰ã€DEBUGï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰ã€ERRORï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„ä¹°å…¥ç­–ç•¥

```python
from modules.buy_strategy import BuyStrategy

def my_custom_strategy(stock_data, **kwargs):
    # å®ç°è‡ªå®šä¹‰ä¹°å…¥é€»è¾‘
    return {'should_buy': True, 'reason': 'è‡ªå®šä¹‰æ¡ä»¶æ»¡è¶³'}

# æ³¨å†Œç­–ç•¥
buy_strategy = BuyStrategy()
buy_strategy.register_strategy('my_strategy', my_custom_strategy)
```

### æ·»åŠ æ–°çš„æŠ¥å‘Šç±»å‹

```python
from modules.report_generator import ReportGenerator

def my_custom_report(data):
    # å®ç°è‡ªå®šä¹‰æŠ¥å‘Šé€»è¾‘
    return {'title': 'è‡ªå®šä¹‰æŠ¥å‘Š', 'content': '...'}

# æ³¨å†ŒæŠ¥å‘Šç±»å‹
report_generator = ReportGenerator()
report_generator.register_report_type('my_report', my_custom_report)
```

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®æº**ï¼šç¨‹åºä¼˜å…ˆä½¿ç”¨ xtdata è·å–çœŸå®æ•°æ®ï¼Œå¦‚æœä¸å¯ç”¨ä¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
2. **æ—¥æœŸæ ¼å¼**ï¼šæ‰€æœ‰æ—¥æœŸå¿…é¡»ä½¿ç”¨ 'YYYYMMDD' æ ¼å¼
3. **è‚¡ç¥¨ä»£ç **ï¼šå¿…é¡»åŒ…å«å¸‚åœºåç¼€ï¼Œå¦‚ '.SZ'ï¼ˆæ·±åœ³ï¼‰æˆ– '.SH'ï¼ˆä¸Šæµ·ï¼‰
4. **äº¤æ˜“æ—¥**ï¼šç¨‹åºä¼šè‡ªåŠ¨å¤„ç†éäº¤æ˜“æ—¥ï¼ŒæŸ¥æ‰¾æœ€è¿‘çš„äº¤æ˜“æ—¥
5. **æ—¥å¿—æ–‡ä»¶**ï¼šå»ºè®®å®šæœŸæ¸…ç† logs ç›®å½•ä¸­çš„æ—§æ—¥å¿—æ–‡ä»¶

## è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

## æ›´æ–°æ—¥å¿—

### v1.0.0 (å½“å‰ç‰ˆæœ¬)
- âœ… å®Œæ•´å®ç°æ”¶ç›Šç‡è®¡ç®—æ¨¡å—
- âœ… é›†æˆ xtdata API æ•°æ®è·å–
- âœ… æ”¯æŒå•ç¬”å’Œæ‰¹é‡äº¤æ˜“å›æµ‹
- âœ… å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿ
- âœ… å¤šç§æŠ¥å‘Šæ ¼å¼
- âœ… æ¨¡æ‹Ÿæ•°æ®å¤‡ç”¨æ–¹æ¡ˆ
- ğŸ”„ å…¶ä»–æ¨¡å—æ¥å£é¢„ç•™ï¼ˆå¾…å®ç°ï¼‰

### è®¡åˆ’åŠŸèƒ½
- ğŸ“‹ å®Œå–„é€‰è‚¡ç­–ç•¥å®ç°
- ğŸ“‹ ä¸°å¯Œä¹°å…¥/å–å‡ºç­–ç•¥
- ğŸ“‹ æ·»åŠ æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
- ğŸ“‹ é£é™©æŒ‡æ ‡è®¡ç®—ï¼ˆå¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ç­‰ï¼‰
- ğŸ“‹ å¯è§†åŒ–å›¾è¡¨ç”Ÿæˆ
- ğŸ“‹ Web ç•Œé¢æ”¯æŒ